#!/bin/bash
set -e
cd "$(dirname "$0")/.."

TIMEOUT_SEC=${TIMEOUT_SEC:-5}
PORT=1334
URL="http://127.0.0.1:$PORT"
BROWSERS="firefox chromium webkit"

EXPECTED_MESSAGES=(
    "debug: log_party"
    "info: log_party"
    "log: log_party"
    "warn: log_party"
    "error: log_party"
)

# Kill any existing process on the port
if lsof -ti:$PORT > /dev/null 2>&1; then
    echo "Killing existing process on port $PORT..."
    lsof -ti:$PORT | xargs kill -9 2>/dev/null || true
    sleep 1
fi

# Start the server
echo "Starting server..."
./scripts/example_log > /dev/null 2>&1 &
SERVER_PID=$!

cleanup() {
    kill $SERVER_PID 2>/dev/null || true
    pkill -9 -P $SERVER_PID 2>/dev/null || true
}
trap cleanup EXIT INT TERM

# Wait for server
for i in $(seq 1 15); do
    if curl -s "$URL" > /dev/null 2>&1; then
        echo "Server is ready!"
        break
    fi
    if [ $i -eq 15 ]; then
        echo "Timeout waiting for server"
        exit 1
    fi
    sleep 1
done

FAILED=0

echo ""
echo "example_log:"

for BROWSER in $BROWSERS; do
    # Map browser name for display
    case $BROWSER in
        webkit) DISPLAY_NAME="safari" ;;
        *) DISPLAY_NAME="$BROWSER" ;;
    esac

    OUTPUT=$(./scripts/run_browser "$URL" --$BROWSER --timeout $TIMEOUT_SEC --omit-stdio-logs 2>&1) || true

    MISSING=0
    for MSG in "${EXPECTED_MESSAGES[@]}"; do
        if ! echo "$OUTPUT" | grep -q "$MSG"; then
            MISSING=1
            break
        fi
    done

    if [ $MISSING -eq 0 ]; then
        echo "$DISPLAY_NAME... web_sys::console::* on the main thread WORKS when run via run_browser"
    else
        echo "$DISPLAY_NAME... web_sys::console::* on the main thread does NOT work when run via run_browser. Do NOT do print-style debugging in this configuration."
        FAILED=$((FAILED + 1))
    fi
done

# Fourth case: Check if wasm-server-runner forwards console output to CLI
cleanup
sleep 1

OUTPUT=$(./scripts/run_browser "$URL" --firefox --timeout $TIMEOUT_SEC --exec "./scripts/example_log" --omit-browser-logs 2>&1) || true

MISSING=0
for MSG in "${EXPECTED_MESSAGES[@]}"; do
    if ! echo "$OUTPUT" | grep -q "$MSG"; then
        MISSING=1
        break
    fi
done

if [ $MISSING -eq 0 ]; then
    echo "CLI... web_sys::console::* on the main thread WORKS when running from terminal"
else
    echo "CLI... web_sys::console::* on the main thread does NOT work when running from terminal. Do NOT do print-style debugging in this configuration."
    FAILED=$((FAILED + 1))
fi

if [ $FAILED -gt 0 ]; then
    exit 1
fi
